use core::arch::asm;

#[allow(non_camel_case_types)]
type c_long = i64;

pub enum Error {
    Unknown(#[allow(unused)] c_long),
}

/// See <https://github.com/riscv-non-isa/riscv-sbi-doc/blob/master/src/binary-encoding.adoc>
#[allow(clippy::too_many_arguments)]
unsafe fn sbi_call(
    eid: c_long,
    fid: c_long,
    a0: c_long,
    a1: c_long,
    a2: c_long,
    a3: c_long,
    a4: c_long,
    a5: c_long,
) -> Result<c_long, Error> {
    let error: c_long;
    let retval: c_long;

    unsafe {
        asm!(
            "ecall",
            inout("a0") a0 => error, inout("a1") a1 => retval, in("a2") a2,
            in("a3") a3, in("a4") a4, in("a5") a5, in("a6") fid, in("a7") eid,
        );
    }

    if error == 0 {
        Ok(retval)
    } else {
        Err(Error::Unknown(error))
    }
}

pub fn set_timer(time: u64) {
    unsafe {
        let _ = sbi_call(0, 0, time as c_long, 0, 0, 0, 0, 0);
    }
}

pub fn console_putchar(c: u8) {
    unsafe {
        let _ = sbi_call(1, 0, c as c_long, 0, 0, 0, 0, 0);
    }
}
